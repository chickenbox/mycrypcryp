var com,DanborutoriReact,mycrypcryp,__awaiter=this&&this.__awaiter||function(e,t,n,r){return new(n||(n=Promise))(function(i,a){function o(e){try{l(r.next(e))}catch(e){a(e)}}function s(e){try{l(r.throw(e))}catch(e){a(e)}}function l(e){e.done?i(e.value):new n(function(t){t(e.value)}).then(o,s)}l((r=r.apply(e,t||[])).next())})};!function(e){let t;!function(e){e.Loading=class{constructor(){this.htmlElement=DanborutoriReact.createElement("div",{style:"position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); background-color: white; border-radius: 4px; padding: 4px;"},"loading")}}}(t=e.view||(e.view={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(e){let t;!function(e){class t{fullUrl(e){return`https://api.binance.com/api/v3${e}`}getExchangeInfo(){return __awaiter(this,void 0,void 0,function*(){return yield(yield fetch(this.fullUrl("/exchangeInfo"))).json()})}getKlineCandlestickData(e,t,n){return __awaiter(this,void 0,void 0,function*(){const r=new URLSearchParams({symbol:e,interval:t});n=n||{};for(let e in n)r.append(e,n[e]);return(yield(yield fetch(this.fullUrl("/klines")+"?"+r)).json()).map(e=>({openTime:new Date(e[0]),open:parseFloat(e[1]),high:parseFloat(e[2]),low:parseFloat(e[3]),close:parseFloat(e[4]),volume:parseFloat(e[5]),closeTime:new Date(e[6]),quoteAssetVolume:parseFloat(e[7]),numberOfTrades:e[8],takerBuyBaseAssetVolume:parseFloat(e[9]),takerBuyQuoteAssetVolume:parseFloat(e[10])}))})}}t.shared=new t,e.Binance=t}(t=e.cryptoApi||(e.cryptoApi={}))}(t=e.danborutori||(e.danborutori={}))}(com||(com={})),function(e){let t;!function(e){let t;!function(e){class t{getPrice(e,t){return __awaiter(this,void 0,void 0,function*(){return(yield(yield fetch(`https://min-api.cryptocompare.com/data/price?fsym=${e}&tsyms=${t}`)).json())[t]})}}t.shared=new t,e.CryptoCompare=t}(t=e.cryptoApi||(e.cryptoApi={}))}(t=e.danborutori||(e.danborutori={}))}(com||(com={})),function(e){e.createElement=function(t,n,...r){let i;switch(t){case"button":i=e.createElement("input",{type:"button"});break;case"checkbox":i=e.createElement("input",{type:"checkbox"});break;case"radio":i=e.createElement("input",{type:"radio"});break;case"file":i=e.createElement("input",{type:"file"});break;case"scroll":(i=e.createElement("div",null)).style.overflow="scroll";break;case"slider":i=e.createElement("input",{type:"range"});break;default:i=document.createElement(t)}if(n)for(let e in n)n.hasOwnProperty(e)&&(e.startsWith("on")?i.addEventListener(e.substring(2),n[e]):i.setAttribute(e,n[e]));let a=r.flatMap(e=>e);for(let e of a)if(e instanceof HTMLElement)i.appendChild(e);else{let t=document.createTextNode(e);i.appendChild(t)}return i}}(DanborutoriReact||(DanborutoriReact={})),Object.defineProperty(Array.prototype,"first",{get(){return this.length>0?this[0]:null}}),Object.defineProperty(Array.prototype,"last",{get(){return this.length>0?this[this.length-1]:null}}),Array.prototype.findClosestIndex=function(e,t){let n=-1,r=1/0;for(let t=0;t<this.length;t++){const i=e(this[t],t);i<r&&(r=i,n=t)}return t&&(t.minDistance=r),n},Array.prototype.insert=function(e,t){this.splice(t,0,e)},Array.prototype.remove=function(e){const t=this[e];return this.splice(e,1),t},Array.prototype.swap=function(e,t){const n=this[e];this[e]=this[t],this[t]=n},Array.prototype.clear=function(){this.length=0},Array.prototype.pushAll=function(e){for(let t of e)this.push(t)},Array.prototype.flatMap=function(e){let t=new Array;for(let n=0;n<this.length;n++){let r=e(this[n],n);if(r instanceof Array)for(let e of r)null!=e&&null!=e&&t.push(e);else null!=r&&null!=r&&t.push(r)}return t},function(e){e.version="0.0.1";e.App=class{run(){return __awaiter(this,void 0,void 0,function*(){document.body.append((new e.scene.Landing).htmlElement)})}}}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(e){e.GraphDrawer=class{constructor(e){this.canvas=e;const t=this.canvas.getContext("2d");t.fillStyle="white",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.lineWidth=1}drawGrid(e,t,n){const r=this.canvas.getContext("2d");r.lineWidth=devicePixelRatio,r.strokeStyle="#eeeeee",r.beginPath();for(let i=0;i<e;i++){const a=t+i*n/(e-1);r.moveTo(a,0),r.lineTo(a,this.canvas.height)}r.stroke()}drawCurve(e,t,n,r,i,a){if(e.length>0){const o=this.canvas.getContext("2d");o.lineWidth=devicePixelRatio,o.strokeStyle=t,o.setLineDash([4*devicePixelRatio,4*devicePixelRatio]),o.beginPath(),o.moveTo(0,(1+a/(i-a))*this.canvas.height),o.lineTo(this.canvas.width,(1+a/(i-a))*this.canvas.height),o.stroke(),o.strokeStyle=t,o.setLineDash([]),o.beginPath();for(let t=0;t<e.length;t++){const s=e[t],l=n+t*r/(e.length-1),c=(1-(s-a)/(i-a))*this.canvas.height;0==t?o.moveTo(l,c):o.lineTo(l,c)}o.stroke()}}isTurningPoint(e,t){return t>0&&Math.sign(e[t].dvddx)*Math.sign(e[t-1].dvddx)<=0}isPeak(e,t){return t>0&&Math.sign(e[t].dvdx)*Math.sign(e[t-1].dvdx)<=0&&e[t].dvddx<=0}isValley(e,t){return t>0&&Math.sign(e[t].dvdx)*Math.sign(e[t-1].dvdx)<=0&&e[t].dvddx>0}visualizeTurningPoint(e,t,n,r,i){if(e.length>0){const a=this.canvas.getContext("2d");for(let o=0;o<e.length;o++){let s;if(this.isTurningPoint(e,o)?s={text:"t",color:"purple"}:this.isPeak(e,o)?s={text:"p",color:"green"}:this.isValley(e,o)&&(s={text:"v",color:"red"}),s){const l=t+o*n/(e.length-1),c=(1-(e[o].value-i)/(r-i))*this.canvas.height;a.fillStyle=s.color,a.textAlign="center",a.font=`${10*devicePixelRatio}px sans-serif`,a.fillText(s.text,l,c)}}}}}}(t=e.helper||(e.helper={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(e){function t(e){return e.map((t,n,r)=>{let i=0,a=0;return n>0&&(i+=t-e[n-1],a++),n+1<e.length&&(i+=e[n+1]-t,a++),0!=a?i/a:0})}e.TrendWatcher=class{constructor(e,n=0){this.data=e;const r=function(e){if(e.length>0){const t=e.reduce((e,t)=>Math.min(e,t.price),e[0].price),n=e.reduce((e,t)=>Math.max(e,t.price),e[0].price);return e.map(e=>({price:(e.price-t)/(n-t),time:e.time,open:e.open,close:e.close}))}return e}(e);this.normalized={high:r.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),low:r.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE),smoothedData:function(e,t){let n=e;for(let e=0;e<t;e++)n=n.map((e,t,r)=>{let i=e.price,a=1;return t>0&&(i+=n[t-1].price,a++),t+1<n.length&&(i+=n[t+1].price,a++),{price:i/a,time:e.time,open:e.open,close:e.close}});return n}(r,n)},this.dDataDt=t(this.normalized.smoothedData.map(e=>e.price)),this.dDataDDt=t(this.dDataDt)}get high(){return this.data.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE)}get low(){return this.data.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE)}get lastProjectedPrice(){const e=this.high,t=this.low;return this.normalized.smoothedData.last.price*(e-t)+t}get lastDDataDt(){if(this.dDataDt.length>0)return this.dDataDt[this.dDataDt.length-1]}}}(t=e.helper||(e.helper={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(t){class n{constructor(){this.loadingView=new e.view.Loading,this.count=0}begin(){0==this.count&&document.body.appendChild(this.loadingView.htmlElement),this.count++}end(){this.count--,0==this.count&&document.body.removeChild(this.loadingView.htmlElement)}}n.shared=new n,t.LoadingManager=n}(t=e.manager||(e.manager={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(t){const n=10,r=1e3,i=20,a=[{title:"last 5 years",dateFunc:function(){let e=new Date;return e.setFullYear(e.getFullYear()-5),e}},{title:"last 1 years",dateFunc:function(){let e=new Date;return e.setFullYear(e.getFullYear()-1),e}},{title:"last 6 months",dateFunc:function(){let e=new Date;return e.setMonth(e.getMonth()-6),e}},{title:"last 3 months",dateFunc:function(){let e=new Date;return e.setMonth(e.getMonth()-3),e}}];t.Landing=class{constructor(){this.infoPanel=new e.view.InfoPanel,this.currentConversion=0,this.interval="1w",this.currentRangeIndex=0,this.openTime=a[0].dateFunc(),this.htmlElement=DanborutoriReact.createElement("div",{style:"position: relative;"}),this.trends=[],this.graphs=[],this.init()}init(){return __awaiter(this,void 0,void 0,function*(){e.manager.LoadingManager.shared.begin();const t=(yield com.danborutori.cryptoApi.Binance.shared.getExchangeInfo()).symbols.filter(t=>t.quoteAsset==e.setting.AppSetting.shared.quoteAsset&&!(t.baseAsset.endsWith("UP")||t.baseAsset.endsWith("DOWN"))),a=yield this.getTrends(t.map(e=>e.baseAsset));e.manager.LoadingManager.shared.end(),this.trends=a,this.refresh(),this.infoPanel.htmlElement.style.position="absolute",this.infoPanel.htmlElement.style.top="8",this.infoPanel.htmlElement.style.right="8",this.infoPanel.set(this.interval,r,n,i),this.htmlElement.appendChild(this.infoPanel.htmlElement)})}refresh(){return __awaiter(this,void 0,void 0,function*(){e.manager.LoadingManager.shared.begin(),yield this.getCurrentConversion(),e.manager.LoadingManager.shared.end();const t=this.trends.sort((t,n)=>{const r=(e.setting.AppSetting.shared.favourite.has(t.baseAsset)?-1:1)-(e.setting.AppSetting.shared.favourite.has(n.baseAsset)?-1:1);return 0!=r?r:Math.abs(t.trend.lastDDataDt)-Math.abs(n.trend.lastDDataDt)});this.htmlElement.innerHTML="",this.htmlElement.appendChild(DanborutoriReact.createElement("center",null,DanborutoriReact.createElement("div",{name:"header"},"1 ",e.setting.AppSetting.shared.quoteAsset," = ",this.currentConversion," ",e.setting.AppSetting.shared.currency,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null),"range: ",DanborutoriReact.createElement("select",{onchange:e=>{const n=e.target;this.currentRangeIndex=n.selectedIndex,this.openTime=a[n.selectedIndex].dateFunc(),this.redraw(t)}},a.map((e,t)=>{const n=DanborutoriReact.createElement("option",null,e.title);return this.currentRangeIndex==t&&(n.selected=!0),n})),DanborutoriReact.createElement("hr",null)),DanborutoriReact.createElement("div",{name:"graphDiv",style:"overflow-y: scroll;"})));const n=Math.max(this.openTime.getTime(),t.reduce((e,t)=>Math.min(e,t.trend.data.first.open.getTime()),Number.MAX_VALUE)),r=t.reduce((e,t)=>Math.max(e,t.trend.data.last.close.getTime()),Number.MIN_VALUE);let i=!1;const o=this.htmlElement.querySelector("div[name=graphDiv]"),s=t.map(t=>{const i=e.setting.AppSetting.shared.favourite.has(t.baseAsset);return this.createGraph(t.baseAsset,e.setting.AppSetting.shared.quoteAsset,t.trend,{open:new Date(n),close:new Date(r)},i)});s.forEach(e=>{e.isFavourite||i||(o.appendChild(DanborutoriReact.createElement("hr",null)),i=!0),o.appendChild(e.element),o.appendChild(DanborutoriReact.createElement("br",null))}),this.graphs=s.map(e=>e.graph),this.htmlElement.appendChild(this.infoPanel.htmlElement);const l=this.htmlElement.querySelector("div[name=header]").getBoundingClientRect();o.style.height=`${innerHeight-l.height-30}px`})}getCurrentConversion(){return __awaiter(this,void 0,void 0,function*(){this.currentConversion=yield com.danborutori.cryptoApi.CryptoCompare.shared.getPrice(e.setting.AppSetting.shared.quoteAsset,e.setting.AppSetting.shared.currency)})}redraw(e){const t=Math.max(this.openTime.getTime(),e.reduce((e,t)=>Math.min(e,t.trend.data.first.open.getTime()),Number.MAX_VALUE)),n=e.reduce((e,t)=>Math.max(e,t.trend.data.last.close.getTime()),Number.MIN_VALUE);this.graphs.forEach(e=>e.update({open:new Date(t),close:new Date(n)}))}getTrends(t){return __awaiter(this,void 0,void 0,function*(){return(yield Promise.all(t.map(t=>__awaiter(this,void 0,void 0,function*(){const a=yield com.danborutori.cryptoApi.Binance.shared.getKlineCandlestickData(`${t}${e.setting.AppSetting.shared.quoteAsset}`,this.interval,{limit:r});if(!(a.length<i))return{baseAsset:t,trend:new e.helper.TrendWatcher(a.map(e=>({price:(e.low+e.high)/2,time:new Date((e.openTime.getTime()+e.closeTime.getTime())/2),open:e.openTime,close:e.closeTime})),n)}})))).filter(e=>e)})}createGraph(t,n,r,i,a){const o=new e.view.SymbolGraph(t,r,i,{currency:e.setting.AppSetting.shared.currency,ratio:this.currentConversion},(e,n)=>{this.addOrRemoveMarker(t,n,e),o.renderGraph()});return o.render(),{element:DanborutoriReact.createElement("div",{style:"display: inline-block;"},DanborutoriReact.createElement("div",{align:"left"},DanborutoriReact.createElement("b",null,t),DanborutoriReact.createElement("input",{onclick:n=>{e.setting.AppSetting.shared.favourite.has(t)?e.setting.AppSetting.shared.favourite.delete(t):e.setting.AppSetting.shared.favourite.add(t),e.setting.AppSetting.shared.commit(),this.refresh()},type:"button",value:a?"★":"☆",style:"float: right;"})),o.htmlElement,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null)),graph:o,isFavourite:a}}addOrRemoveMarker(t,n,r){const i=e.setting.AppSetting.shared.markers.get(t)||[],a=i.findIndex(e=>Math.abs(e.getTime()-r.getTime())<=n);a>=0?i.remove(a):(i.push(r),e.setting.AppSetting.shared.markers.set(t,i)),e.setting.AppSetting.shared.commit()}}}(t=e.scene||(e.scene={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(e){class t{constructor(){this.localStorageKey="mycrypcryp.setting.AppSetting.data",this.markers=new Map;try{this._data=JSON.parse(localStorage.getItem(this.localStorageKey))||{}}catch(e){this._data={}}this.favourite=new Set(this._data.favourite||["BTC","ETH","PAXG"]);for(let e in this._data.markers||{})this.markers.set(e,this._data.markers[e].map(e=>new Date(e)))}get currency(){return this._data.currency||"HKD"}get quoteAsset(){return this._data.quoteAsset||"USDT"}updateInternalData(){this._data.favourite=Array.from(this.favourite.keys()),this._data.markers=this._data.markers||{};for(let e of this.markers)this._data.markers[e[0]]=e[1].map(e=>e.getTime())}commit(){this.updateInternalData(),localStorage.setItem(this.localStorageKey,JSON.stringify(this._data))}export(){return this.updateInternalData(),btoa(JSON.stringify(this._data))}import(e){localStorage.setItem(this.localStorageKey,atob(e)),location.reload()}}t.shared=new t,e.AppSetting=t}(t=e.setting||(e.setting={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(t){t.InfoPanel=class{constructor(){this.htmlElement=DanborutoriReact.createElement("div",{align:"right",style:"display: inline-block; background-color: white; padding: 4px; border: 1px solid black; border-radius: 4px;"}),this.isExpand=!1,this.htmlElement.onclick=(e=>{this.isExpand=!this.isExpand,this.refresh()}),this.refresh()}set(e,t,n,r){this.interval=e,this.limit=t,this.smoothItr=n,this.minimumSample=r,this.refresh()}refresh(){this.isExpand?(this.htmlElement.innerHTML="",this.htmlElement.appendChild(DanborutoriReact.createElement("div",null,"info",DanborutoriReact.createElement("br",null),"interval: ",this.interval," limit: ",this.limit,DanborutoriReact.createElement("br",null),"smoothItr: ",this.smoothItr," minimum sample: ",this.minimumSample,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("font",{size:"2"},"version ",e.version),DanborutoriReact.createElement("br",null),"setting: ",DanborutoriReact.createElement("input",{type:"button",value:"export",onclick:t=>__awaiter(this,void 0,void 0,function*(){const t=e.setting.AppSetting.shared.export();e.manager.LoadingManager.shared.begin(),yield navigator.clipboard.writeText(t),e.manager.LoadingManager.shared.end()})}),DanborutoriReact.createElement("input",{type:"button",value:"import",onclick:t=>{const n=prompt("Please paste setting string here:");n&&e.setting.AppSetting.shared.import(n)}})))):this.htmlElement.innerHTML="info"}}}(t=e.view||(e.view={}))}(mycrypcryp||(mycrypcryp={})),function(e){let t;!function(t){t.SymbolGraph=class{constructor(e,t,n,r,i){this.baseAsset=e,this.trend=t,this.range=n,this.quoteToCurrency=r,this.onClick=i,this.htmlElement=DanborutoriReact.createElement("div",{style:"display: inline-block"},DanborutoriReact.createElement("div",{style:"display: inline-block"},DanborutoriReact.createElement("canvas",{name:"graphCanvas",width:200*devicePixelRatio,height:100*devicePixelRatio,style:"width: 200px; height: 100px;"}),DanborutoriReact.createElement("div",null,DanborutoriReact.createElement("font",{size:"2"},DanborutoriReact.createElement("div",{name:"from",style:"display: inline-block; float:left;"},"from 2"),DanborutoriReact.createElement("div",{name:"to",style:"float:right;"},"to")))),DanborutoriReact.createElement("div",{align:"left"},DanborutoriReact.createElement("font",{size:"2"},DanborutoriReact.createElement("div",{name:"info",align:"left",style:"display: inline-block;"}))));const a=this.htmlElement.querySelector("canvas[name=graphCanvas]");a.addEventListener("pointermove",e=>{this.onMouseMove(e.offsetX)},{passive:!0}),a.addEventListener("pointerleave",e=>{this.onMouseOut()},{passive:!0}),a.addEventListener("pointerout",e=>{this.onMouseOut()},{passive:!0}),a.addEventListener("pointerdown",e=>{this.onMouseDown(e.offsetX,e.target)},{passive:!0})}update(e){this.range.open=e.open,this.range.close=e.close,this.render()}updateInfo(e){const t=this.htmlElement.querySelector("div[name=info]"),n=e.data.filter(e=>!(e.open>this.range.close||e.close<this.range.open)),r=n.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),i=n.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE);t.innerHTML="",t.appendChild(DanborutoriReact.createElement("div",null,"H/L: ",(r/i).toFixed(5)," samples: ",e.data.length,DanborutoriReact.createElement("br",null),"high: ",(r*this.quoteToCurrency.ratio).toFixed(5),this.quoteToCurrency.currency,DanborutoriReact.createElement("br",null),"low: ",(i*this.quoteToCurrency.ratio).toFixed(5),this.quoteToCurrency.currency,DanborutoriReact.createElement("br",null),"last proj: ",(e.lastProjectedPrice*this.quoteToCurrency.ratio).toFixed(5)))}render(){this.renderGraph();const e=this.htmlElement.querySelector("div[name=from]"),t=this.htmlElement.querySelector("div[name=to]");e.innerText=moment(this.range.open).format("MMMyyyy"),t.innerText=moment(this.range.close).format("MMMyyyy")}renderGraph(t){const n=this.htmlElement.querySelector("canvas[name=graphCanvas]"),r=this.trend;this.updateInfo(r);const i=(r.data.first.time.getTime()-this.range.open.getTime())*n.width/(this.range.close.getTime()-this.range.open.getTime()),a=(r.data.last.time.getTime()-this.range.open.getTime())*n.width/(this.range.close.getTime()-this.range.open.getTime())-i,o=new e.helper.GraphDrawer(n);o.drawCurve(r.data.map(e=>e.price),"grey",i,a,r.data.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),r.data.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE)),o.drawCurve(r.normalized.smoothedData.map(e=>e.price),"green",i,a,r.normalized.high,r.normalized.low),o.visualizeTurningPoint(r.normalized.smoothedData.map((e,t)=>({value:e.price,dvdx:r.dDataDt[t],dvddx:r.dDataDDt[t]})),i,a,r.normalized.high,r.normalized.low);const s=n.getContext("2d"),l=e.setting.AppSetting.shared.markers.get(this.baseAsset)||[];for(let e of l){s.strokeStyle="#ffaaaa",s.lineWidth=devicePixelRatio;const t=(e.getTime()-this.range.open.getTime())*n.width/(this.range.close.getTime()-this.range.open.getTime());s.beginPath(),s.moveTo(t,0),s.lineTo(t,n.height),s.stroke()}null!=t&&(s.strokeStyle="black",s.lineWidth=devicePixelRatio,s.beginPath(),s.moveTo(t,0),s.lineTo(t,n.height),s.stroke())}onMouseMove(e){this.renderGraph(e)}onMouseOut(){this.renderGraph()}onMouseDown(e,t){const n=new Date(e*(this.range.close.getTime()-this.range.open.getTime())/t.width+this.range.open.getTime()),r=10*(this.range.close.getTime()-this.range.open.getTime())/t.width;this.onClick(n,r)}}}(t=e.view||(e.view={}))}(mycrypcryp||(mycrypcryp={}));