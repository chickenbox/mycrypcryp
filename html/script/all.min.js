var com,DanborutoriReact,mycrypcryp,__awaiter=this&&this.__awaiter||function(a,o,s,l){return new(s=s||Promise)(function(e,t){function r(e){try{i(l.next(e))}catch(e){t(e)}}function n(e){try{i(l.throw(e))}catch(e){t(e)}}function i(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,n)}i((l=l.apply(a,o||[])).next())})};!function(e){(e.view||(e.view={})).Loading=class{constructor(){this.htmlElement=DanborutoriReact.createElement("div",{style:"position: absolute; left: 50%; top: 50%; transform: translate(-50%,-50%); background-color: white; border-radius: 4px; padding: 4px;"},"loading")}}}(mycrypcryp=mycrypcryp||{}),function(e){(function(e){class t{getPrice(e,t){return __awaiter(this,void 0,void 0,function*(){return(yield(yield fetch(`https://min-api.cryptocompare.com/data/price?fsym=${e}&tsyms=${t}`)).json())[t]})}}t.shared=new t,e.CryptoCompare=t})((e=e.danborutori||(e.danborutori={})).cryptoApi||(e.cryptoApi={}))}(com=com||{}),function(e){(function(e){class t{fullUrl(e){return`https://api.binance.com/api/v3${e}`}getExchangeInfo(){return __awaiter(this,void 0,void 0,function*(){const e=yield fetch(this.fullUrl("/exchangeInfo"));return yield e.json()})}getKlineCandlestickData(n,i,a){return __awaiter(this,void 0,void 0,function*(){const e=new URLSearchParams({symbol:n,interval:i});for(var t in a=a||{})e.append(t,a[t]);const r=yield fetch(this.fullUrl("/klines")+"?"+e);return(yield r.json()).map(e=>({openTime:new Date(e[0]),open:parseFloat(e[1]),high:parseFloat(e[2]),low:parseFloat(e[3]),close:parseFloat(e[4]),volume:parseFloat(e[5]),closeTime:new Date(e[6]),quoteAssetVolume:parseFloat(e[7]),numberOfTrades:e[8],takerBuyBaseAssetVolume:parseFloat(e[9]),takerBuyQuoteAssetVolume:parseFloat(e[10])}))})}}t.shared=new t,e.Binance=t})((e=e.danborutori||(e.danborutori={})).cryptoApi||(e.cryptoApi={}))}(com=com||{}),function(s){s.createElement=function(e,t,...r){let n;switch(e){case"button":n=s.createElement("input",{type:"button"});break;case"checkbox":n=s.createElement("input",{type:"checkbox"});break;case"radio":n=s.createElement("input",{type:"radio"});break;case"file":n=s.createElement("input",{type:"file"});break;case"scroll":n=s.createElement("div",null),n.style.overflow="scroll";break;case"slider":n=s.createElement("input",{type:"range"});break;default:n=document.createElement(e)}if(t)for(var i in t)t.hasOwnProperty(i)&&(i.startsWith("on")?n.addEventListener(i.substring(2),t[i]):n.setAttribute(i,t[i]));var a,o;for(a of r.flatMap(e=>e))a instanceof HTMLElement?n.appendChild(a):(o=document.createTextNode(a),n.appendChild(o));return n}}(DanborutoriReact=DanborutoriReact||{}),Object.defineProperty(Array.prototype,"first",{get(){return 0<this.length?this[0]:null}}),Object.defineProperty(Array.prototype,"last",{get(){return 0<this.length?this[this.length-1]:null}}),Array.prototype.findClosestIndex=function(t,e){let r=-1,n=1/0;for(let e=0;e<this.length;e++){var i=t(this[e],e);i<n&&(n=i,r=e)}return e&&(e.minDistance=n),r},Array.prototype.insert=function(e,t){this.splice(t,0,e)},Array.prototype.remove=function(e){var t=this[e];return this.splice(e,1),t},Array.prototype.swap=function(e,t){var r=this[e];this[e]=this[t],this[t]=r},Array.prototype.clear=function(){this.length=0},Array.prototype.pushAll=function(e){for(var t of e)this.push(t)},Array.prototype.flatMap=function(t){let r=new Array;for(let e=0;e<this.length;e++){var n=t(this[e],e);if(n instanceof Array)for(var i of n)null!=i&&null!=i&&r.push(i);else null!=n&&null!=n&&r.push(n)}return r},function(e){e.version="0.0.1";e.App=class{run(){return __awaiter(this,void 0,void 0,function*(){document.body.append((new e.scene.Landing).htmlElement)})}}}(mycrypcryp=mycrypcryp||{}),function(e){(e.helper||(e.helper={})).GraphDrawer=class{constructor(e){this.canvas=e;const t=this.canvas.getContext("2d");t.fillStyle="white",t.fillRect(0,0,this.canvas.width,this.canvas.height),t.lineWidth=1}drawGrid(t,r,n){const i=this.canvas.getContext("2d");i.lineWidth=1,i.strokeStyle="#eeeeee",i.beginPath();for(let e=0;e<t;e++){var a=r+e*n/(t-1);i.moveTo(a,0),i.lineTo(a,this.canvas.height)}i.stroke()}drawCurve(t,e,r,n,i,a){if(0<t.length){const l=this.canvas.getContext("2d");l.lineWidth=1,l.strokeStyle=e,l.setLineDash([4,4]),l.beginPath(),l.moveTo(0,(1+a/(i-a))*this.canvas.height),l.lineTo(this.canvas.width,(1+a/(i-a))*this.canvas.height),l.stroke(),l.strokeStyle=e,l.setLineDash([]),l.beginPath();for(let e=0;e<t.length;e++){var o=t[e],s=r+e*n/(t.length-1),o=(1-(o-a)/(i-a))*this.canvas.height;0==e?l.moveTo(s,o):l.lineTo(s,o)}l.stroke()}}isTurningPoint(e,t){return 0<t&&Math.sign(e[t].dvddx)*Math.sign(e[t-1].dvddx)<=0}isPeak(e,t){return 0<t&&Math.sign(e[t].dvdx)*Math.sign(e[t-1].dvdx)<=0&&e[t].dvddx<=0}isValley(e,t){return 0<t&&Math.sign(e[t].dvdx)*Math.sign(e[t-1].dvdx)<=0&&0<e[t].dvddx}visualizeTurningPoint(r,n,i,a,o){if(0<r.length){const c=this.canvas.getContext("2d");for(let t=0;t<r.length;t++){let e;var s,l;this.isTurningPoint(r,t)?e={text:"t",color:"purple"}:this.isPeak(r,t)?e={text:"p",color:"green"}:this.isValley(r,t)&&(e={text:"v",color:"red"}),e&&(s=n+t*i/(r.length-1),l=(1-(r[t].value-o)/(a-o))*this.canvas.height,c.fillStyle=e.color,c.textAlign="center",c.fillText(e.text,s,l))}}}}}(mycrypcryp=mycrypcryp||{}),function(e){function n(a){return a.map((e,t,r)=>{let n=0,i=0;return 0<t&&(n+=e-a[t-1],i++),t+1<a.length&&(n+=a[t+1]-e,i++),0!=i?n/i:0})}(e.helper||(e.helper={})).TrendWatcher=class{constructor(e,t=0){const r=function(e){if(0<e.length){const t=e.reduce((e,t)=>Math.min(e,t.price),e[0].price),r=e.reduce((e,t)=>Math.max(e,t.price),e[0].price);return e.map(e=>({price:(e.price-t)/(r-t),time:e.time,open:e.open,close:e.close}))}return e}(this.data=e);this.normalized={high:r.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),low:r.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE),smoothedData:function(e,t){let a=e;for(let e=0;e<t;e++)a=a.map((e,t,r)=>{let n=e.price,i=1;return 0<t&&(n+=a[t-1].price,i++),t+1<a.length&&(n+=a[t+1].price,i++),{price:n/i,time:e.time,open:e.open,close:e.close}});return a}(r,t)},this.dDataDt=n(this.normalized.smoothedData.map(e=>e.price)),this.dDataDDt=n(this.dDataDt)}get high(){return this.data.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE)}get low(){return this.data.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE)}get lastProjectedPrice(){var e=this.high,t=this.low;return this.normalized.smoothedData.last.price*(e-t)+t}get lastDDataDt(){if(0<this.dDataDt.length)return this.dDataDt[this.dDataDt.length-1]}}}(mycrypcryp=mycrypcryp||{}),function(r){!function(e){class t{constructor(){this.loadingView=new r.view.Loading,this.count=0}begin(){0==this.count&&document.body.appendChild(this.loadingView.htmlElement),this.count++}end(){this.count--,0==this.count&&document.body.removeChild(this.loadingView.htmlElement)}}t.shared=new t,e.LoadingManager=t}(r.manager||(r.manager={}))}(mycrypcryp=mycrypcryp||{}),function(c){!function(e){const l=[{title:"last 5 years",dateFunc:function(){let e=new Date;return e.setFullYear(e.getFullYear()-5),e}},{title:"last 1 years",dateFunc:function(){let e=new Date;return e.setFullYear(e.getFullYear()-1),e}},{title:"last 6 months",dateFunc:function(){let e=new Date;return e.setMonth(e.getMonth()-6),e}},{title:"last 3 months",dateFunc:function(){let e=new Date;return e.setMonth(e.getMonth()-3),e}}];e.Landing=class{constructor(){this.infoPanel=new c.view.InfoPanel,this.currentConversion=0,this.interval="1w",this.currentRangeIndex=0,this.openTime=l[0].dateFunc(),this.htmlElement=DanborutoriReact.createElement("div",{style:"position: relative;"}),this.trends=[],this.graphs=[],this.init()}init(){return __awaiter(this,void 0,void 0,function*(){c.manager.LoadingManager.shared.begin();const e=yield com.danborutori.cryptoApi.Binance.shared.getExchangeInfo(),t=e.symbols.filter(e=>e.quoteAsset==c.setting.AppSetting.shared.quoteAsset);var r=yield this.getTrends(t.map(e=>e.baseAsset));c.manager.LoadingManager.shared.end(),this.trends=r,this.refresh(),this.infoPanel.htmlElement.style.position="absolute",this.infoPanel.htmlElement.style.top="8",this.infoPanel.htmlElement.style.right="8",this.infoPanel.set(this.interval,1e3,10,20),this.htmlElement.appendChild(this.infoPanel.htmlElement)})}refresh(){return __awaiter(this,void 0,void 0,function*(){c.manager.LoadingManager.shared.begin(),yield this.getCurrentConversion(),c.manager.LoadingManager.shared.end();const t=this.trends.sort((e,t)=>{var r=(c.setting.AppSetting.shared.favourite.has(e.baseAsset)?-1:1)-(c.setting.AppSetting.shared.favourite.has(t.baseAsset)?-1:1);return 0!=r?r:Math.abs(e.trend.lastDDataDt)-Math.abs(t.trend.lastDDataDt)});this.htmlElement.innerHTML="",this.htmlElement.appendChild(DanborutoriReact.createElement("center",null,DanborutoriReact.createElement("div",{name:"header"},"1 ",c.setting.AppSetting.shared.quoteAsset," = ",this.currentConversion," ",c.setting.AppSetting.shared.currency,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null),"range: ",DanborutoriReact.createElement("select",{onchange:e=>{e=e.target;this.currentRangeIndex=e.selectedIndex,this.openTime=l[e.selectedIndex].dateFunc(),this.redraw(t)}},l.map((e,t)=>{const r=DanborutoriReact.createElement("option",null,e.title);return this.currentRangeIndex==t&&(r.selected=!0),r})),DanborutoriReact.createElement("hr",null)),DanborutoriReact.createElement("div",{name:"graphDiv",style:"overflow-y: scroll;"})));const r=Math.max(this.openTime.getTime(),t.reduce((e,t)=>Math.min(e,t.trend.data.first.open.getTime()),Number.MAX_VALUE)),n=t.reduce((e,t)=>Math.max(e,t.trend.data.last.close.getTime()),Number.MIN_VALUE);let i=!1;const a=this.htmlElement.querySelector("div[name=graphDiv]"),e=t.map(e=>{var t=c.setting.AppSetting.shared.favourite.has(e.baseAsset);return this.createGraph(e.baseAsset,c.setting.AppSetting.shared.quoteAsset,e.trend,{open:new Date(r),close:new Date(n)},t)});e.forEach(e=>{e.isFavourite||i||(a.appendChild(DanborutoriReact.createElement("hr",null)),i=!0),a.appendChild(e.element),a.appendChild(DanborutoriReact.createElement("br",null))}),this.graphs=e.map(e=>e.graph),this.htmlElement.appendChild(this.infoPanel.htmlElement);const o=this.htmlElement.querySelector("div[name=header]");var s=o.getBoundingClientRect();a.style.height=`${innerHeight-s.height-30}px`})}getCurrentConversion(){return __awaiter(this,void 0,void 0,function*(){this.currentConversion=yield com.danborutori.cryptoApi.CryptoCompare.shared.getPrice(c.setting.AppSetting.shared.quoteAsset,c.setting.AppSetting.shared.currency)})}redraw(e){const t=Math.max(this.openTime.getTime(),e.reduce((e,t)=>Math.min(e,t.trend.data.first.open.getTime()),Number.MAX_VALUE)),r=e.reduce((e,t)=>Math.max(e,t.trend.data.last.close.getTime()),Number.MIN_VALUE);this.graphs.forEach(e=>e.update({open:new Date(t),close:new Date(r)}))}getTrends(e){return __awaiter(this,void 0,void 0,function*(){return(yield Promise.all(e.map(t=>__awaiter(this,void 0,void 0,function*(){const e=yield com.danborutori.cryptoApi.Binance.shared.getKlineCandlestickData(`${t}${c.setting.AppSetting.shared.quoteAsset}`,this.interval,{limit:1e3});if(!(e.length<20))return{baseAsset:t,trend:new c.helper.TrendWatcher(e.map(e=>({price:(e.low+e.high)/2,time:new Date((e.openTime.getTime()+e.closeTime.getTime())/2),open:e.openTime,close:e.closeTime})),10)}})))).filter(e=>e)})}createGraph(r,e,t,n,i){const a=new c.view.SymbolGraph(r,t,n,{currency:c.setting.AppSetting.shared.currency,ratio:this.currentConversion},(e,t)=>{this.addOrRemoveMarker(r,t,e),a.renderGraph()});return a.render(),{element:DanborutoriReact.createElement("div",{style:"display: inline-block;"},DanborutoriReact.createElement("div",{align:"left"},DanborutoriReact.createElement("b",null,r),DanborutoriReact.createElement("input",{onclick:e=>{c.setting.AppSetting.shared.favourite.has(r)?c.setting.AppSetting.shared.favourite.delete(r):c.setting.AppSetting.shared.favourite.add(r),c.setting.AppSetting.shared.commit(),this.refresh()},type:"button",value:i?"★":"☆",style:"float: right;"})),a.htmlElement,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null)),graph:a,isFavourite:i}}addOrRemoveMarker(e,t,r){const n=c.setting.AppSetting.shared.markers.get(e)||[];var i=n.findIndex(e=>Math.abs(e.getTime()-r.getTime())<=t);0<=i?n.remove(i):(n.push(r),c.setting.AppSetting.shared.markers.set(e,n)),c.setting.AppSetting.shared.commit()}}}(c.scene||(c.scene={}))}(mycrypcryp=mycrypcryp||{}),function(e){!function(e){class t{constructor(){this.localStorageKey="mycrypcryp.setting.AppSetting.data",this.markers=new Map;try{this._data=JSON.parse(localStorage.getItem(this.localStorageKey))||{}}catch(e){this._data={}}for(var e in this.favourite=new Set(this._data.favourite||["BTC","ETH","PAXG"]),this._data.markers||{})this.markers.set(e,this._data.markers[e].map(e=>new Date(e)))}get currency(){return this._data.currency||"HKD"}get quoteAsset(){return this._data.quoteAsset||"USDT"}updateInternalData(){this._data.favourite=Array.from(this.favourite.keys()),this._data.markers=this._data.markers||{};for(var e of this.markers)this._data.markers[e[0]]=e[1].map(e=>e.getTime())}commit(){this.updateInternalData(),localStorage.setItem(this.localStorageKey,JSON.stringify(this._data))}export(){return this.updateInternalData(),btoa(JSON.stringify(this._data))}import(e){localStorage.setItem(this.localStorageKey,atob(e)),location.reload()}}t.shared=new t,e.AppSetting=t}(e.setting||(e.setting={}))}(mycrypcryp=mycrypcryp||{}),function(r){(r.view||(r.view={})).InfoPanel=class{constructor(){this.htmlElement=DanborutoriReact.createElement("div",{align:"right",style:"display: inline-block; background-color: white; padding: 4px; border: 1px solid black; border-radius: 4px;"}),this.isExpand=!1,this.htmlElement.onclick=e=>{this.isExpand=!this.isExpand,this.refresh()},this.refresh()}set(e,t,r,n){this.interval=e,this.limit=t,this.smoothItr=r,this.minimumSample=n,this.refresh()}refresh(){this.isExpand?(this.htmlElement.innerHTML="",this.htmlElement.appendChild(DanborutoriReact.createElement("div",null,"info",DanborutoriReact.createElement("br",null),"interval: ",this.interval," limit: ",this.limit,DanborutoriReact.createElement("br",null),"smoothItr: ",this.smoothItr," minimum sample: ",this.minimumSample,DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("br",null),DanborutoriReact.createElement("font",{size:"2"},"version ",r.version),DanborutoriReact.createElement("br",null),"setting: ",DanborutoriReact.createElement("input",{type:"button",value:"export",onclick:e=>__awaiter(this,void 0,void 0,function*(){var e=r.setting.AppSetting.shared.export();r.manager.LoadingManager.shared.begin(),yield navigator.clipboard.writeText(e),r.manager.LoadingManager.shared.end()})}),DanborutoriReact.createElement("input",{type:"button",value:"import",onclick:e=>{var t=prompt("Please paste setting string here:");t&&r.setting.AppSetting.shared.import(t)}})))):this.htmlElement.innerHTML="info"}}}(mycrypcryp=mycrypcryp||{}),function(l){(l.view||(l.view={})).SymbolGraph=class{constructor(e,t,r,n,i){this.baseAsset=e,this.trend=t,this.range=r,this.quoteToCurrency=n,this.onClick=i,this.htmlElement=DanborutoriReact.createElement("div",{style:"display: inline-block"},DanborutoriReact.createElement("div",{style:"display: inline-block"},DanborutoriReact.createElement("canvas",{name:"graphCanvas",width:"200",height:"100"}),DanborutoriReact.createElement("div",null,DanborutoriReact.createElement("font",{size:"2"},DanborutoriReact.createElement("div",{name:"from",style:"display: inline-block; float:left;"},"from 2"),DanborutoriReact.createElement("div",{name:"to",style:"float:right;"},"to")))),DanborutoriReact.createElement("div",{align:"left"},DanborutoriReact.createElement("font",{size:"2"},DanborutoriReact.createElement("div",{name:"info",align:"left",style:"display: inline-block;"}))));const a=this.htmlElement.querySelector("canvas[name=graphCanvas]");a.addEventListener("pointermove",e=>{this.onMouseMove(e.offsetX)},{passive:!0}),a.addEventListener("pointerleave",e=>{this.onMouseOut()},{passive:!0}),a.addEventListener("pointerout",e=>{this.onMouseOut()},{passive:!0}),a.addEventListener("pointerdown",e=>{this.onMouseDown(e.offsetX,e.target)},{passive:!0})}update(e){this.range.open=e.open,this.range.close=e.close,this.render()}updateInfo(e){const t=this.htmlElement.querySelector("div[name=info]"),r=e.data.filter(e=>!(e.open>this.range.close||e.close<this.range.open));var n=r.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),i=r.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE);t.innerHTML="",t.appendChild(DanborutoriReact.createElement("div",null,"H/L: ",(n/i).toFixed(5)," samples: ",e.data.length,DanborutoriReact.createElement("br",null),"high: ",(n*this.quoteToCurrency.ratio).toFixed(5),this.quoteToCurrency.currency,DanborutoriReact.createElement("br",null),"low: ",(i*this.quoteToCurrency.ratio).toFixed(5),this.quoteToCurrency.currency,DanborutoriReact.createElement("br",null),"last proj: ",(e.lastProjectedPrice*this.quoteToCurrency.ratio).toFixed(5)))}render(){this.renderGraph();const e=this.htmlElement.querySelector("div[name=from]"),t=this.htmlElement.querySelector("div[name=to]");e.innerText=moment(this.range.open).format("MMMyyyy"),t.innerText=moment(this.range.close).format("MMMyyyy")}renderGraph(e){const t=this.htmlElement.querySelector("canvas[name=graphCanvas]"),r=this.trend;this.updateInfo(r);const n=(r.data.first.time.getTime()-this.range.open.getTime())*t.width/(this.range.close.getTime()-this.range.open.getTime());var i,a=(r.data.last.time.getTime()-this.range.open.getTime())*t.width/(this.range.close.getTime()-this.range.open.getTime())-n;const o=new l.helper.GraphDrawer(t);o.drawCurve(r.data.map(e=>e.price),"grey",n,a,r.data.reduce((e,t)=>Math.max(e,t.price),Number.MIN_VALUE),r.data.reduce((e,t)=>Math.min(e,t.price),Number.MAX_VALUE)),o.drawCurve(r.normalized.smoothedData.map(e=>e.price),"green",n,a,r.normalized.high,r.normalized.low),o.visualizeTurningPoint(r.normalized.smoothedData.map((e,t)=>({value:e.price,dvdx:r.dDataDt[t],dvddx:r.dDataDDt[t]})),n,a,r.normalized.high,r.normalized.low);const s=t.getContext("2d");for(i of l.setting.AppSetting.shared.markers.get(this.baseAsset)||[]){s.strokeStyle="#ffaaaa",s.lineWidth=1;const n=(i.getTime()-this.range.open.getTime())*t.width/(this.range.close.getTime()-this.range.open.getTime());s.beginPath(),s.moveTo(n,0),s.lineTo(n,t.height),s.stroke()}null!=e&&(s.strokeStyle="black",s.lineWidth=1,s.beginPath(),s.moveTo(e,0),s.lineTo(e,t.height),s.stroke())}onMouseMove(e){this.renderGraph(e)}onMouseOut(){this.renderGraph()}onMouseDown(e,t){e=new Date(e*(this.range.close.getTime()-this.range.open.getTime())/t.width+this.range.open.getTime()),t=10*(this.range.close.getTime()-this.range.open.getTime())/t.width;this.onClick(e,t)}}}(mycrypcryp=mycrypcryp||{});